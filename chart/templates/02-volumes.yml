{{- $claims := ternary .Values.storage.production.claims .Values.storage.development.claims .Values.is_production }}

{{- range $key, $claim := $claims }}
{{- if eq $claim.className "nfs" }}

---
apiVersion: v1
kind: PersistentVolume
metadata:
  name: {{ $claim.name }}-volume
spec:
  capacity:
    storage: {{ $claim.size }}
  volumeMode: Filesystem
  accessModes:
    - {{ $claim.accessMode }}
  persistentVolumeReclaimPolicy: Retain
  storageClassName: {{ $claim.className }}
  {{- $mountOpts := default .Values.storage.nfsMountOptions $claim.mountOptions }}
  {{- if $mountOpts }}
  mountOptions:
    {{- range $mountOpts }}
    - {{ . }}
    {{- end }}
  {{- end }}
  nfs:
    server: {{ $claim.nfs.server }}
    path: {{ $claim.nfs.path }}
    readOnly: {{ $claim.nfs.readOnly }}

{{- end }}

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $claim.name }}-claim
spec:
  storageClassName: {{ $claim.className }}
  accessModes:
    - {{ $claim.accessMode }}
  volumeMode: Filesystem
  resources:
    requests:
      storage: {{ $claim.size }}
  {{- if eq $claim.className "nfs" }}
  volumeName: {{ $claim.name }}-volume
  {{- end }}

{{- end }}
